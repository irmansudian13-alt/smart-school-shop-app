<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART School SHOP App</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Dark slate gray text */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Darker indigo */
        }
        .btn-secondary {
            background-color: #64748b; /* Slate gray */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover {
            background-color: #475569; /* Darker slate gray */
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            border: 1px solid #cbd5e1; /* Light gray border */
            border-radius: 0.375rem;
            padding: 0.625rem 1rem;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 1rem;
            background-color: #f8fafc; /* Lighter background for inputs */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #e2e8f0; /* Lighter gray border */
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background-color: #e0e7ff; /* Light indigo for table headers */
            font-weight: 600;
            color: #334155;
        }
        tr:nth-child(even) {
            background-color: #f8fafc; /* Zebra striping for table rows */
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50; /* Green for success */
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.error {
            background-color: #f44336; /* Red for error */
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #e2e8f0;
            color: #475569;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
        }
        .tab-content {
            border-top: 2px solid #4f46e5;
            padding-top: 1.5rem;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container py-8">
        <h1 class="text-4xl font-bold text-center mb-4 text-indigo-700">SMART School SHOP App</h1>
        <p id="userIdDisplay" class="text-center text-sm text-gray-600 mb-8">User ID: Loading...</p>

        <!-- Message Box for notifications -->
        <div id="messageBox" class="message-box"></div>

        <!-- Tab Navigation -->
        <div class="flex mb-4">
            <button class="tab-button active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-button" onclick="showTab('sales')">Penjualan</button>
            <button class="tab-button" onclick="showTab('expenses')">Pengeluaran</button>
            <button class="tab-button" onclick="showTab('stock')">Stok Barang</button>
            <button class="tab-button" onclick="showTab('attendance')">Daftar Hadir Siswa</button>
            <button class="tab-button" onclick="showTab('settings')">Pengaturan</button>
        </div>

        <!-- Dashboard Tab Content -->
        <div id="dashboard" class="tab-content card">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Ringkasan Keuangan</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-100 p-4 rounded-lg shadow-sm">
                    <p class="text-lg font-medium">Total Penjualan:</p>
                    <p id="totalSales" class="text-3xl font-bold text-blue-700">Rp 0</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg shadow-sm">
                    <p class="text-lg font-medium">Total Pengeluaran:</p>
                    <p id="totalExpenses" class="text-3xl font-bold text-red-700">Rp 0</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg shadow-sm">
                    <p class="text-lg font-medium">Laba Bersih:</p>
                    <p id="netProfit" class="text-3xl font-bold text-green-700">Rp 0</p>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-indigo-600">Transaksi Terakhir</h3>
            <div class="overflow-x-auto">
                <table id="recentTransactionsTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Tipe</th>
                            <th>Deskripsi</th>
                            <th>Jumlah (Rp)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Recent transactions will be loaded here by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Tab Content -->
        <div id="sales" class="tab-content card hidden">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Catat Penjualan Baru</h2>
            <form id="salesForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="saleProduct" class="block text-sm font-medium text-gray-700 mb-1">Produk:</label>
                    <select id="saleProduct" required>
                        <option value="">Pilih Produk</option>
                        <!-- Products will be loaded here by JS -->
                    </select>
                </div>
                <div>
                    <label for="saleQuantity" class="block text-sm font-medium text-gray-700 mb-1">Jumlah:</label>
                    <input type="number" id="saleQuantity" min="1" value="1" required>
                </div>
                <div>
                    <label for="saleMethod" class="block text-sm font-medium text-gray-700 mb-1">Metode Pembayaran:</label>
                    <select id="saleMethod" required>
                        <option value="QRIS DANA">QRIS DANA</option>
                        <option value="Tunai">Tunai</option>
                    </select>
                </div>
                <div>
                    <label for="saleDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal:</label>
                    <input type="date" id="saleDate" required>
                </div>
                <div class="md:col-span-2">
                    <label for="saleAttendant" class="block text-sm font-medium text-gray-700 mb-1">Petugas Penjual:</label>
                    <select id="saleAttendant" required>
                        <option value="">Pilih Siswa</option>
                        <!-- Students will be loaded here by JS -->
                    </select>
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn-primary">Catat Penjualan</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold mt-8 mb-3 text-indigo-600">Daftar Penjualan</h3>
            <div class="overflow-x-auto">
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Produk</th>
                            <th>Jumlah</th>
                            <th>Harga Satuan (Rp)</th>
                            <th>Total (Rp)</th>
                            <th>Metode</th>
                            <th>Petugas</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sales records will be loaded here by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenses Tab Content -->
        <div id="expenses" class="tab-content card hidden">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Catat Pengeluaran Baru</h2>
            <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="expenseType" class="block text-sm font-medium text-gray-700 mb-1">Jenis Pengeluaran:</label>
                    <select id="expenseType" required>
                        <option value="">Pilih Jenis</option>
                        <option value="Pembelian Stok">Pembelian Stok</option>
                        <option value="Biaya Promosi">Biaya Promosi</option>
                        <option value="Biaya Listrik">Biaya Listrik</option>
                        <option value="Lain-lain">Lain-lain</option>
                    </select>
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp):</label>
                    <input type="number" id="expenseAmount" min="1" required>
                </div>
                <div class="md:col-span-2">
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi:</label>
                    <textarea id="expenseDescription" rows="2" placeholder="Contoh: Pembelian seragam dari Vendor X" required></textarea>
                </div>
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal:</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div>
                    <label for="expenseAttendant" class="block text-sm font-medium text-gray-700 mb-1">Petugas Pencatat:</label>
                    <select id="expenseAttendant" required>
                        <option value="">Pilih Siswa</option>
                        <!-- Students will be loaded here by JS -->
                    </select>
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn-primary">Catat Pengeluaran</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold mt-8 mb-3 text-indigo-600">Daftar Pengeluaran</h3>
            <div class="overflow-x-auto">
                <table id="expensesTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Jenis</th>
                            <th>Deskripsi</th>
                            <th>Jumlah (Rp)</th>
                            <th>Petugas</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Expense records will be loaded here by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Stock Tab Content -->
        <div id="stock" class="tab-content card hidden">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Manajemen Stok Barang</h2>

            <h3 class="text-xl font-semibold mb-3 text-indigo-600">Tambah/Edit Produk</h3>
            <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Nama Produk:</label>
                    <input type="text" id="productName" placeholder="Contoh: Baju Seragam Putih Abu" required>
                </div>
                <div>
                    <label for="productSize" class="block text-sm font-medium text-gray-700 mb-1">Ukuran (Opsional):</label>
                    <input type="text" id="productSize" placeholder="Contoh: S, M, L, XL atau 'All Size'">
                </div>
                <div>
                    <label for="productBuyPrice" class="block text-sm font-medium text-gray-700 mb-1">Harga Beli (Modal Rp):</label>
                    <input type="number" id="productBuyPrice" min="0" required>
                </div>
                <div>
                    <label for="productSellPrice" class="block text-sm font-medium text-gray-700 mb-1">Harga Jual (Rp):</label>
                    <input type="number" id="productSellPrice" min="0" required>
                </div>
                <div>
                    <label for="productStock" class="block text-sm font-medium text-gray-700 mb-1">Stok Awal:</label>
                    <input type="number" id="productStock" min="0" value="0" required>
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn-primary">Tambah/Update Produk</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold mt-8 mb-3 text-indigo-600">Daftar Stok</h3>
            <div class="overflow-x-auto">
                <table id="stockTable">
                    <thead>
                        <tr>
                            <th>Nama Produk</th>
                            <th>Ukuran</th>
                            <th>Harga Beli (Rp)</th>
                            <th>Harga Jual (Rp)</th>
                            <th>Stok</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Stock records will be loaded here by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Attendance Tab Content -->
        <div id="attendance" class="tab-content card hidden">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Catat Daftar Hadir Siswa</h2>
            <form id="attendanceForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="attendanceDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal:</label>
                    <input type="date" id="attendanceDate" required>
                </div>
                <div>
                    <label for="attendanceShift" class="block text-sm font-medium text-gray-700 mb-1">Shift/Waktu Tugas:</label>
                    <input type="text" id="attendanceShift" placeholder="Contoh: Pagi (08:00-12:00)" required>
                </div>
                <div class="md:col-span-2">
                    <label for="attendanceStudent" class="block text-sm font-medium text-gray-700 mb-1">Nama Siswa:</label>
                    <select id="attendanceStudent" required>
                        <option value="">Pilih Siswa</option>
                        <!-- Students will be loaded here by JS -->
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="attendanceStatus" class="block text-sm font-medium text-gray-700 mb-1">Status Kehadiran:</label>
                    <select id="attendanceStatus" required>
                        <option value="Hadir">Hadir</option>
                        <option value="Izin">Izin</option>
                        <option value="Sakit">Sakit</option>
                        <option value="Alpha">Alpha</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn-primary">Catat Kehadiran</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold mt-8 mb-3 text-indigo-600">Daftar Kehadiran</h3>
            <div class="overflow-x-auto">
                <table id="attendanceTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Shift</th>
                            <th>Nama Siswa</th>
                            <th>Jurusan</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Attendance records will be loaded here by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab Content -->
        <div id="settings" class="tab-content card hidden">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Pengaturan Data Master</h2>

            <h3 class="text-xl font-semibold mb-3 text-indigo-600">Manajemen Siswa (Petugas SPW)</h3>
            <form id="studentForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Nama Siswa:</label>
                    <input type="text" id="studentName" placeholder="Contoh: Budi Santoso" required>
                </div>
                <div>
                    <label for="studentMajor" class="block text-sm font-medium text-gray-700 mb-1">Jurusan:</label>
                    <select id="studentMajor" required>
                        <option value="">Pilih Jurusan</option>
                        <option value="TO">TO</option>
                        <option value="TM">TM</option>
                        <option value="TL">TL</option>
                        <option value="TKJ">TKJ</option>
                        <option value="DPIB">DPIB</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn-primary">Tambah Siswa</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold mt-8 mb-3 text-indigo-600">Daftar Siswa</h3>
            <div class="overflow-x-auto">
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th>Nama Siswa</th>
                            <th>Jurusan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Student records will be loaded here by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Import getAnalytics

        // --- Global Variables (Canvas Injected) ---
        // These variables are provided by the Canvas environment at runtime.
        // If running outside Canvas (e.g., on Cloudflare Pages), they will be undefined,
        // so we provide default empty values or handle their absence.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'smart-school-shop-default';
        const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD4fBs0c6dIycDbuFew1355aDuJYgMm8Q0",
  authDomain: "smart-school-shop-app.firebaseapp.com",
  projectId: "smart-school-shop-app",
  storageBucket: "smart-school-shop-app.firebasestorage.app",
  messagingSenderId: "334558132445",
  appId: "1:334558132445:web:998241d5bd4672d24ec334",
  measurementId: "G-EX61980YME"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

        // If running in Canvas and __firebase_config is provided, use it. Otherwise, use the hardcoded one.
        const finalFirebaseConfig = Object.keys(firebaseConfigFromCanvas).length > 0 ? firebaseConfigFromCanvas : firebaseConfig;

        // --- Firebase Initialization ---
        let app;
        let db;
        let auth;
        let analytics; // Declare analytics variable
        let currentUserId = null;
        let isAuthReady = false; // Flag to ensure auth is ready before Firestore ops

        // Initialize Firebase and set up authentication listener
        async function initializeFirebase() {
            try {
                app = initializeApp(finalFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // Initialize Analytics if measurementId is present
                if (finalFirebaseConfig.measurementId) {
                    analytics = getAnalytics(app);
                    console.log("Firebase Analytics initialized.");
                }


                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `User ID: ${currentUserId}`;
                        isAuthReady = true;
                        console.log("Firebase Authenticated. User ID:", currentUserId);
                        // Once authenticated, load data
                        loadAllData();
                    } else {
                        // Sign in anonymously if no user is logged in
                        console.log("No user logged in, signing in anonymously...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Error signing in:", error);
                            showMessage("Gagal login ke Firebase. Coba muat ulang halaman.", "error");
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage("Gagal menginisialisasi Firebase. Pastikan konfigurasi benar.", "error");
            }
        }

        // --- Firestore Collection References ---
        // Data will be stored under /artifacts/{appId}/users/{userId}/{collectionName}
        function getCollectionRef(collectionName) {
            if (!db || !currentUserId || !appId) {
                console.error("Firestore DB, User ID, or App ID not ready.");
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${currentUserId}/${collectionName}`);
        }

        // --- Utility Functions ---
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`;
            messageBox.style.display = 'block';
            messageBox.style.opacity = '1';

            setTimeout(() => {
                messageBox.style.opacity = '0';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 300);
            }, 3000);
        }

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        // --- Data Storage (Now using Firebase Firestore) ---
        let products = [];
        let sales = [];
        let expenses = [];
        let students = [];
        let attendance = [];

        // --- Real-time Data Loading with onSnapshot ---
        function loadAllData() {
            if (!isAuthReady) {
                console.warn("Authentication not ready, cannot load data.");
                return;
            }

            // Products Listener
            onSnapshot(getCollectionRef('products'), (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
                populateProductDropdowns();
                updateDashboard(); // Update dashboard after products load
                console.log("Products loaded from Firestore:", products.length);
            }, (error) => {
                console.error("Error loading products:", error);
                showMessage("Gagal memuat produk dari database.", "error");
            });

            // Sales Listener
            onSnapshot(getCollectionRef('sales'), (snapshot) => {
                sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSales();
                updateDashboard(); // Update dashboard after sales load
                console.log("Sales loaded from Firestore:", sales.length);
            }, (error) => {
                console.error("Error loading sales:", error);
                showMessage("Gagal memuat penjualan dari database.", "error");
            });

            // Expenses Listener
            onSnapshot(getCollectionRef('expenses'), (snapshot) => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExpenses();
                updateDashboard(); // Update dashboard after expenses load
                console.log("Expenses loaded from Firestore:", expenses.length);
            }, (error) => {
                console.error("Error loading expenses:", error);
                showMessage("Gagal memuat pengeluaran dari database.", "error");
            });

            // Students Listener
            onSnapshot(getCollectionRef('students'), (snapshot) => {
                students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStudents();
                populateStudentDropdowns();
                console.log("Students loaded from Firestore:", students.length);
            }, (error) => {
                console.error("Error loading students:", error);
                showMessage("Gagal memuat data siswa dari database.", "error");
            });

            // Attendance Listener
            onSnapshot(getCollectionRef('attendance'), (snapshot) => {
                attendance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAttendance();
                console.log("Attendance loaded from Firestore:", attendance.length);
            }, (error) => {
                console.error("Error loading attendance:", error);
                showMessage("Gagal memuat data kehadiran dari database.", "error");
            });
        }

        // --- Tab Management ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

            // Refresh data when switching tabs (render functions will be called by onSnapshot listeners)
            // We call updateDashboard explicitly as it aggregates data from multiple collections
            if (tabId === 'dashboard') updateDashboard();
        }

        // --- Dashboard Functions ---
        function updateDashboard() {
            const totalSales = sales.reduce((sum, item) => sum + item.totalPrice, 0);
            const totalExpenses = expenses.reduce((sum, item) => sum + item.amount, 0);
            const netProfit = totalSales - totalExpenses;

            document.getElementById('totalSales').textContent = formatRupiah(totalSales);
            document.getElementById('totalExpenses').textContent = formatRupiah(totalExpenses);
            document.getElementById('netProfit').textContent = formatRupiah(netProfit);

            renderRecentTransactions();
        }

        function renderRecentTransactions() {
            const tableBody = document.getElementById('recentTransactionsTable').querySelector('tbody');
            tableBody.innerHTML = '';

            const allTransactions = [
                ...sales.map(s => ({ date: s.date, type: 'Penjualan', description: `${s.productName} (${s.quantity})`, amount: s.totalPrice })),
                ...expenses.map(e => ({ date: e.date, type: 'Pengeluaran', description: e.description, amount: -e.amount }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            if (allTransactions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">Belum ada transaksi.</td></tr>';
                return;
            }

            allTransactions.forEach(trans => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = trans.date;
                row.insertCell().textContent = trans.type;
                row.insertCell().textContent = trans.description;
                const amountCell = row.insertCell();
                amountCell.textContent = formatRupiah(trans.amount);
                amountCell.className = trans.amount >= 0 ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';
            });
        }

        // --- Sales Functions ---
        async function addSale(newSale) {
            try {
                if (!getCollectionRef('sales')) return;
                await addDoc(getCollectionRef('sales'), newSale);
                showMessage('Penjualan berhasil dicatat!');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Gagal mencatat penjualan.", "error");
            }
        }

        async function deleteSale(id) {
            if (confirm('Apakah Anda yakin ingin menghapus penjualan ini? Stok tidak akan dikembalikan secara otomatis.')) {
                try {
                    if (!getCollectionRef('sales')) return;
                    await deleteDoc(doc(getCollectionRef('sales'), id));
                    showMessage('Penjualan berhasil dihapus.');
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    showMessage("Gagal menghapus penjualan.", "error");
                }
            }
        }

        function renderSales() {
            const tableBody = document.getElementById('salesTable').querySelector('tbody');
            tableBody.innerHTML = '';

            if (sales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">Belum ada data penjualan.</td></tr>';
                return;
            }

            sales.forEach((sale) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = sale.date;
                row.insertCell().textContent = sale.productName;
                row.insertCell().textContent = sale.quantity;
                row.insertCell().textContent = formatRupiah(sale.unitPrice);
                row.insertCell().textContent = formatRupiah(sale.totalPrice);
                row.insertCell().textContent = sale.method;
                row.insertCell().textContent = sale.attendant;

                const actionCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Hapus';
                deleteBtn.className = 'btn-secondary text-sm px-3 py-1';
                deleteBtn.onclick = () => deleteSale(sale.id);
                actionCell.appendChild(deleteBtn);
            });
            populateProductDropdowns();
            populateStudentDropdowns();
            document.getElementById('saleDate').valueAsDate = new Date();
        }

        document.getElementById('salesForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const productName = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const method = document.getElementById('saleMethod').value;
            const date = document.getElementById('saleDate').value;
            const attendant = document.getElementById('saleAttendant').value;

            const product = products.find(p => `${p.name} ${p.size}`.trim() === productName);

            if (!product) {
                showMessage('Produk tidak ditemukan. Harap tambahkan produk di tab Stok Barang.', 'error');
                return;
            }
            if (product.stock < quantity) {
                showMessage(`Stok ${product.name} (${product.size || 'All Size'}) tidak mencukupi. Tersedia: ${product.stock}`, 'error');
                return;
            }

            const newSale = {
                date: date,
                productName: productName,
                quantity: quantity,
                unitPrice: product.sellPrice,
                totalPrice: product.sellPrice * quantity,
                method: method,
                attendant: attendant
            };

            await addSale(newSale); // Add to Firestore
            await updateProductStock(product.id, product.stock - quantity); // Update stock in Firestore
            this.reset();
            document.getElementById('saleDate').valueAsDate = new Date();
        });

        // --- Expenses Functions ---
        async function addExpense(newExpense) {
            try {
                if (!getCollectionRef('expenses')) return;
                await addDoc(getCollectionRef('expenses'), newExpense);
                showMessage('Pengeluaran berhasil dicatat!');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Gagal mencatat pengeluaran.", "error");
            }
        }

        async function deleteExpense(id) {
            if (confirm('Apakah Anda yakin ingin menghapus pengeluaran ini?')) {
                try {
                    if (!getCollectionRef('expenses')) return;
                    await deleteDoc(doc(getCollectionRef('expenses'), id));
                    showMessage('Pengeluaran berhasil dihapus.');
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    showMessage("Gagal menghapus pengeluaran.", "error");
                }
            }
        }

        function renderExpenses() {
            const tableBody = document.getElementById('expensesTable').querySelector('tbody');
            tableBody.innerHTML = '';

            if (expenses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Belum ada data pengeluaran.</td></tr>';
                return;
            }

            expenses.forEach((expense) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = expense.date;
                row.insertCell().textContent = expense.type;
                row.insertCell().textContent = expense.description;
                row.insertCell().textContent = formatRupiah(expense.amount);
                row.insertCell().textContent = expense.attendant;

                const actionCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Hapus';
                deleteBtn.className = 'btn-secondary text-sm px-3 py-1';
                deleteBtn.onclick = () => deleteExpense(expense.id);
                actionCell.appendChild(deleteBtn);
            });
            populateStudentDropdowns();
            document.getElementById('expenseDate').valueAsDate = new Date();
        }

        document.getElementById('expenseForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const type = document.getElementById('expenseType').value;
            const amount = parseInt(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value;
            const date = document.getElementById('expenseDate').value;
            const attendant = document.getElementById('expenseAttendant').value;

            const newExpense = {
                date: date,
                type: type,
                amount: amount,
                description: description,
                attendant: attendant
            };

            await addExpense(newExpense);
            this.reset();
            document.getElementById('expenseDate').valueAsDate = new Date();
        });

        // --- Product/Stock Functions ---
        async function addOrUpdateProduct(productData, productId = null) {
            try {
                if (!getCollectionRef('products')) return;
                if (productId) {
                    await setDoc(doc(getCollectionRef('products'), productId), productData);
                    showMessage('Produk berhasil diupdate!');
                } else {
                    await addDoc(getCollectionRef('products'), productData);
                    showMessage('Produk berhasil ditambahkan!');
                }
            } catch (e) {
                console.error("Error adding/updating product: ", e);
                showMessage("Gagal menyimpan produk.", "error");
            }
        }

        async function updateProductStock(productId, newStock) {
            try {
                if (!getCollectionRef('products')) return;
                await setDoc(doc(getCollectionRef('products'), productId), { stock: newStock }, { merge: true });
                console.log("Stok produk berhasil diupdate.");
            } catch (e) {
                console.error("Error updating product stock: ", e);
                showMessage("Gagal memperbarui stok produk.", "error");
            }
        }

        async function deleteProduct(id) {
            if (confirm('Apakah Anda yakin ingin menghapus produk ini? Ini akan menghapus semua data produk terkait.')) {
                try {
                    if (!getCollectionRef('products')) return;
                    await deleteDoc(doc(getCollectionRef('products'), id));
                    showMessage('Produk berhasil dihapus.');
                } catch (e) {
                    console.error("Error deleting product: ", e);
                    showMessage("Gagal menghapus produk.", "error");
                }
            }
        }

        function renderProducts() {
            const tableBody = document.getElementById('stockTable').querySelector('tbody');
            tableBody.innerHTML = '';

            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Belum ada produk. Tambahkan produk baru.</td></tr>';
                return;
            }

            products.forEach((product) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = product.name;
                row.insertCell().textContent = product.size || '-';
                row.insertCell().textContent = formatRupiah(product.buyPrice);
                row.insertCell().textContent = formatRupiah(product.sellPrice);
                row.insertCell().textContent = product.stock;

                const statusCell = row.insertCell();
                if (product.stock <= 5 && product.stock > 0) {
                    statusCell.textContent = 'Menipis';
                    statusCell.className = 'text-orange-500 font-semibold';
                } else if (product.stock === 0) {
                    statusCell.textContent = 'Habis';
                    statusCell.className = 'text-red-500 font-semibold';
                } else {
                    statusCell.textContent = 'Cukup';
                    statusCell.className = 'text-green-500';
                }

                const actionCell = row.insertCell();
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'btn-primary text-sm px-3 py-1 mr-2';
                editBtn.onclick = () => editProduct(product.id);
                actionCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Hapus';
                deleteBtn.className = 'btn-secondary text-sm px-3 py-1';
                deleteBtn.onclick = () => deleteProduct(product.id);
                actionCell.appendChild(deleteBtn);
            });
            populateProductDropdowns();
        }

        let editingProductId = null; // To keep track of which product is being edited

        document.getElementById('productForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const name = document.getElementById('productName').value.trim();
            const size = document.getElementById('productSize').value.trim();
            const buyPrice = parseInt(document.getElementById('productBuyPrice').value);
            const sellPrice = parseInt(document.getElementById('productSellPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);

            const productData = {
                name: name,
                size: size,
                buyPrice: buyPrice,
                sellPrice: sellPrice,
                stock: stock
            };

            if (editingProductId) {
                await addOrUpdateProduct(productData, editingProductId);
                editingProductId = null; // Reset editing state
            } else {
                // Check for duplicate product name + size before adding new
                const existingProduct = products.find(p => p.name === name && p.size === size);
                if (existingProduct) {
                    showMessage('Produk dengan nama dan ukuran yang sama sudah ada. Gunakan tombol Edit untuk mengubahnya.', 'error');
                    return;
                }
                await addOrUpdateProduct(productData);
            }

            this.reset();
        });

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                document.getElementById('productName').value = product.name;
                document.getElementById('productSize').value = product.size;
                document.getElementById('productBuyPrice').value = product.buyPrice;
                document.getElementById('productSellPrice').value = product.sellPrice;
                document.getElementById('productStock').value = product.stock;
                editingProductId = id; // Set editing state
                showMessage('Form produk diisi untuk diedit. Tekan "Tambah/Update Produk" untuk menyimpan perubahan.');
            }
        }

        function populateProductDropdowns() {
            const selectElement = document.getElementById('saleProduct');
            selectElement.innerHTML = '<option value="">Pilih Produk</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = `${product.name} ${product.size}`.trim();
                option.textContent = `${product.name} ${product.size ? `(${product.size})` : ''} - ${formatRupiah(product.sellPrice)}`;
                selectElement.appendChild(option);
            });
        }

        // --- Student Management Functions ---
        async function addStudent(newStudent) {
            try {
                if (!getCollectionRef('students')) return;
                await addDoc(getCollectionRef('students'), newStudent);
                showMessage('Siswa berhasil ditambahkan!');
            } catch (e) {
                console.error("Error adding student: ", e);
                showMessage("Gagal menambahkan siswa.", "error");
            }
        }

        async function deleteStudent(id) {
            if (confirm('Apakah Anda yakin ingin menghapus siswa ini? Ini akan menghapus siswa dari daftar master.')) {
                try {
                    if (!getCollectionRef('students')) return;
                    await deleteDoc(doc(getCollectionRef('students'), id));
                    showMessage('Siswa berhasil dihapus.');
                } catch (e) {
                    console.error("Error deleting student: ", e);
                    showMessage("Gagal menghapus siswa.", "error");
                }
            }
        }

        function renderStudents() {
            const tableBody = document.getElementById('studentsTable').querySelector('tbody');
            tableBody.innerHTML = '';

            if (students.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">Belum ada siswa. Tambahkan siswa baru.</td></tr>';
                return;
            }

            students.forEach((student) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = student.name;
                row.insertCell().textContent = student.major;

                const actionCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Hapus';
                deleteBtn.className = 'btn-secondary text-sm px-3 py-1';
                deleteBtn.onclick = () => deleteStudent(student.id);
                actionCell.appendChild(deleteBtn);
            });
            populateStudentDropdowns();
        }

        document.getElementById('studentForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const name = document.getElementById('studentName').value.trim();
            const major = document.getElementById('studentMajor').value;

            if (students.some(s => s.name === name)) {
                showMessage('Nama siswa sudah ada.', 'error');
                return;
            }

            const newStudent = {
                name: name,
                major: major
            };

            await addStudent(newStudent);
            this.reset();
        });

        function populateStudentDropdowns() {
            const salesAttendantSelect = document.getElementById('saleAttendant');
            const expenseAttendantSelect = document.getElementById('expenseAttendant');
            const attendanceStudentSelect = document.getElementById('attendanceStudent');

            salesAttendantSelect.innerHTML = '<option value="">Pilih Siswa</option>';
            expenseAttendantSelect.innerHTML = '<option value="">Pilih Siswa</option>';
            attendanceStudentSelect.innerHTML = '<option value="">Pilih Siswa</option>';

            students.forEach(student => {
                const option1 = document.createElement('option');
                option1.value = student.name;
                option1.textContent = `${student.name} (${student.major})`;
                salesAttendantSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = student.name;
                option2.textContent = `${student.name} (${student.major})`;
                expenseAttendantSelect.appendChild(option2);

                const option3 = document.createElement('option');
                option3.value = student.name;
                option3.textContent = `${student.name} (${student.major})`;
                attendanceStudentSelect.appendChild(option3);
            });
        }

        // --- Attendance Functions ---
        async function addAttendance(newRecord) {
            try {
                if (!getCollectionRef('attendance')) return;
                await addDoc(getCollectionRef('attendance'), newRecord);
                showMessage('Kehadiran siswa berhasil dicatat!');
            } catch (e) {
                console.error("Error adding attendance: ", e);
                showMessage("Gagal mencatat kehadiran.", "error");
            }
        }

        async function deleteAttendance(id) {
            if (confirm('Apakah Anda yakin ingin menghapus catatan kehadiran ini?')) {
                try {
                    if (!getCollectionRef('attendance')) return;
                    await deleteDoc(doc(getCollectionRef('attendance'), id));
                    showMessage('Catatan kehadiran berhasil dihapus.');
                } catch (e) {
                    console.error("Error deleting attendance: ", e);
                    showMessage("Gagal menghapus catatan kehadiran.", "error");
                }
            }
        }

        function renderAttendance() {
            const tableBody = document.getElementById('attendanceTable').querySelector('tbody');
            tableBody.innerHTML = '';

            const sortedAttendance = [...attendance].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedAttendance.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Belum ada data kehadiran.</td></tr>';
                return;
            }

            sortedAttendance.forEach((record) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = record.date;
                row.insertCell().textContent = record.shift;
                row.insertCell().textContent = record.studentName;
                const student = students.find(s => s.name === record.studentName);
                row.insertCell().textContent = student ? student.major : '-';
                row.insertCell().textContent = record.status;

                const actionCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Hapus';
                deleteBtn.className = 'btn-secondary text-sm px-3 py-1';
                deleteBtn.onclick = () => deleteAttendance(record.id);
                actionCell.appendChild(deleteBtn);
            });
            populateStudentDropdowns();
            document.getElementById('attendanceDate').valueAsDate = new Date();
        }

        document.getElementById('attendanceForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const date = document.getElementById('attendanceDate').value;
            const shift = document.getElementById('attendanceShift').value.trim();
            const studentName = document.getElementById('attendanceStudent').value;
            const status = document.getElementById('attendanceStatus').value;

            const isDuplicate = attendance.some(record =>
                record.date === date &&
                record.shift === shift &&
                record.studentName === studentName
            );

            if (isDuplicate) {
                showMessage('Siswa ini sudah dicatat kehadirannya untuk tanggal dan shift yang sama.', 'error');
                return;
            }

            const newRecord = {
                date: date,
                shift: shift,
                studentName: studentName,
                status: status
            };

            await addAttendance(newRecord);
            this.reset();
            document.getElementById('attendanceDate').valueAsDate = new Date();
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('saleDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('attendanceDate').value = today;

            initializeFirebase(); // Initialize Firebase on DOMContentLoaded
            showTab('dashboard'); // Show dashboard initially
        });
    </script>
</body>
</html>
